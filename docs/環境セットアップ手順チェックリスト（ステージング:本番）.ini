````
# 環境セットアップ手順チェックリスト（ステージング/本番）

## Notes
- 環境分離: Firebase（`emca-stg` / `emca-prod`）、Notion（投稿DB/タグDBをstg/prodで分離）、iOSバンドルID（`com.example.emca.stg` / `com.example.emca`）
- リージョン: `europe-west3`（Firestore/Storage/Cloud Functionsを統一）
- 認証: メール/パスワード＋Google＋Sign in with Apple（Googleはstg/prodでOAuthクライアント分離）
- 秘密情報: Firebase Functions runtime configを使用（環境ごとに設定）
- APNs: Auth Keyは共用（Key ID/Team ID/p8をFirebaseに登録）

# Tasks
- [ ] 1.0 Apple Developer/Bundle ID/Capabilities
  - [ ] 1.1 バンドルID作成: `com.example.emca`（本番）, `com.example.emca.stg`（ステージング）
  - [ ] 1.2 Capabilities有効化（両方）: Push Notifications, Sign in with Apple, Keychain Sharing（必要時）
  - [ ] 1.3 APNs Auth Key作成（共用）: Key ID/Team ID/p8ダウンロード保管

- [ ] 2.0 Firebase プロジェクト作成
  - [ ] 2.1 `emca-stg`（ステージング）作成（リージョン: `europe-west3`）
  - [ ] 2.2 `emca-prod`（本番）作成（リージョン: `europe-west3`）
  - [ ] 2.3 iOSアプリ登録（各プロジェクト）: バンドルID（stg/prod）、アプリ名（表示名を環境別に）
  - [ ] 2.4 GoogleService-Info.plist を各環境で取得・保管（後でスキーム別に紐付け）

- [ ] 3.0 Firebase Authentication 設定（各環境）
  - [ ] 3.1 プロバイダ有効化: Email/Password, Google, Apple
  - [ ] 3.2 Google OAuthクライアントIDを環境ごとに発行（iOS用、バンドルIDで設定）
  - [ ] 3.3 Sign in with Appleを有効化（Services ID/Bundle ID対応、Return URL/Key設定）
  - [ ] 3.4 認証メール/アクションURLのドメイン確認（Dynamic Links等を利用する場合）

- [ ] 4.0 FCM/APNs 連携（各環境）
  - [ ] 4.1 FirebaseコンソールにAPNs Auth Key（共用）をアップロード（Key ID/Team ID/p8）
  - [ ] 4.2 通知権限/トークン取得〜受信の疎通（実機）を後日E2Eで確認

- [ ] 5.0 Firestore/Storage/Functions 基盤（各環境）
  - [ ] 5.1 Firestoreのロケーション: `europe-west3` を確認
  - [ ] 5.2 Storageのロケーション: `europe-west3` を確認（バケット命名を控える）
  - [ ] 5.3 Cloud Functionsのデフォルトリージョン: `europe-west3` に設定

- [ ] 6.0 Firestore セキュリティ/インデックス（各環境）
  - [ ] 6.1 ルール方針反映（認証必須、所有権、管理者Claimsでの非表示/削除）
  - [ ] 6.2 インデックス作成:
    - [ ] 6.2.1 `comments`: `postId+createdAt`（昇順）
    - [ ] 6.2.2 `comments`: `parentId+createdAt`（昇順）
    - [ ] 6.2.3 `bookmarks`: `userId+createdAt`（降順）
    - [ ] 6.2.4 `notifications`: `userId+createdAt`（降順）

- [ ] 7.0 Storage ルール/ポリシー（各環境）
  - [ ] 7.1 認証ユーザーのみアップロード可
  - [ ] 7.2 受け入れ制約の運用: PNG/JPG、≤5MB、16:9以外は中央トリミング
  - [ ] 7.3 公開URL生成ポリシー（カバー画像の公開範囲）

- [ ] 8.0 Notion（stg/prod 分離）
  - [ ] 8.1 Notionインテグレーション作成（Botトークン発行）
  - [ ] 8.2 投稿DB（本番）: 共有権限付与、DB ID控え
    - [ ] 8.2.1 `POSTS_DB_ID_PROD = 280aae8f429e80ffb552ce7bf85cb4b4` を確認
  - [ ] 8.3 投稿DB（ステージング）: 作成→同スキーマで権限付与→DB ID取得（`POSTS_DB_ID_STG`）
  - [ ] 8.4 タグDB（本番/ステージング）: 作成→権限付与→DB ID取得（`TAGS_DB_ID_PROD` / `TAGS_DB_ID_STG`）
  - [ ] 8.5 初期データ投入（カテゴリ候補、タグセット）
  - [ ] 8.6 Notion APIのレート/CSP注意点の運用メモ化

- [ ] 9.0 Firebase Functions runtime config（秘密情報）（各環境で実行）
  - [ ] 9.1 `notion.token`（Botトークン）
  - [ ] 9.2 `notion.posts_db_id`（stg/prod それぞれ）
  - [ ] 9.3 `notion.tags_db_id`（stg/prod それぞれ）
  - [ ] 9.4 `cache.ttl.list` = 60（秒）, `cache.ttl.detail` = 300（秒）
  - [ ] 9.5 `canva.allow_domains`（スマート埋め込み許可ドメイン）
  - [ ] 9.6 必要に応じ `apple.team_id` / `apple.key_id` / `apple.service_id`（Sign in with Apple連携）

- [ ] 10.0 iOS ビルド構成/差別化（Xcode）
  - [ ] 10.1 Schemes: `EMCA`（prod）, `EMCAStg`（stg）
  - [ ] 10.2 Configurations: Debug-Prod/Release-Prod、Debug-Stg/Release-Stg
  - [ ] 10.3 Deployment Target: iOS 18（両方）
  - [ ] 10.4 Orientation: iPhone=Portrait、iPad=Portrait/Landscape
  - [ ] 10.5 表示名/アイコン: ステージングは接尾辞/専用アイコンで識別
  - [ ] 10.6 Push/Background Modes/Keychain等 Entitlements整合
  - [ ] 10.7 GoogleService-Info.plist を各スキームと紐付け（stg/prodで切替）

- [ ] 11.0 認証プロバイダの疎通（各環境）
  - [ ] 11.1 Email/Passwordでサインアップ/ログイン
  - [ ] 11.2 Google Sign-In（stg/prod各OAuthで実機確認）
  - [ ] 11.3 Sign in with Apple（本番/ステージング Bundleに対する疎通）

- [ ] 12.0 Functions デプロイ（各環境）
  - [ ] 12.1 リージョン `europe-west3` 指定でデプロイ
  - [ ] 12.2 ランタイム変数の反映確認（一覧/詳細のTTL、Notion DB ID）
  - [ ] 12.3 ヘルスチェック用エンドポイント/ログの確認

- [ ] 13.0 動作検証（環境別）
  - [ ] 13.1 投稿作成→Notion反映→一覧/詳細キャッシュ反映（60s/300s）
  - [ ] 13.2 Canva埋め込み表示（ブロック時フォールバックUI表示）
  - [ ] 13.3 コメント/いいね/ブックマーク/通知の最低限疎通
  - [ ] 13.4 端末（iPhone 16e/11 Pro、iPad 第10）での動作差異確認

- [ ] 14.0 運用メモ/権限
  - [ ] 14.1 Notion DB共有ロールの最小権限（Botに必要権限のみ）
  - [ ] 14.2 Firebase IAMロール（デプロイ・閲覧・運用の権限分離）
  - [ ] 14.3 Secret/キーの保管場所とローテーション手順

- [ ] 15.0 引き継ぎ/記録
  - [ ] 15.1 環境変数一覧・設定手順の最終版ドキュメント化
  - [ ] 15.2 不具合時のキャッシュパージ/ロールバックRunbookの参照先明記
````