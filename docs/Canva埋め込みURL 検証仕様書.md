# Canva埋め込みURL 検証仕様書 (v1.0 Draft)

## 1. 目的
本仕様は、ユーザーが投稿フォームから送信する「Canvaスマート埋め込みURL」が、意図した形式（Canvaの公開埋め込みリンク）であることを保証するために定義する。
これにより、セキュリティリスク（任意のWebサイトの埋め込みなど）を防止する。

## 2. 検証対象
* **API:** `POST /posts` (新規投稿作成API)
* **対象フィールド:** [ (例: `canva_embed_url` フィールド) ]

## 3. 検証ルール
APIサーバーサイドは、受信したURLが以下の**すべての条件**を満たすか検証する。

### 3.1 許可ドメイン
URLのホスト名（ドメイン）は、以下のいずれかに完全一致する必要がある。
* `www.canva.com`
* `canva.com`

### 3.2 必須パス
URLのパス（ドメイン以降の部分）は、特定のパターンに一致する必要がある。
* **必須パターン:** [ (例: `/design/` から始まり、 `/view` で終わる) ]

### 3.3 必須クエリパラメータ
URLのクエリ（ `?` 以降の部分）には、埋め込みを示す特定のパラメータが**必須**で含まれている必要がある。
* **必須パラメータ:** [ (例: `embed` (値は問わない)) ]

---

## 4. 検証ロジック (実装方針)
* Cloud Functions側で、上記3.1〜3.3のルールに基づいた**正規表現(Regex)**を作成し、バリデーションを行う。
* **想定Regexパターン (仮):**
  ```regex
  ^https:\/\/(www\.)?canva\.com\/design\/[a-zA-Z0-9_-]+\/view\?.*embed.*$
  ```
  *(このパターンは、実際のCanva URLを分析した上で確定させる)*

## 5. エラー処理
検証ルール（3.1〜3.3のいずれか）に違反したURLが送信された場合、APIは以下のレスポンスを返す。
* **HTTPステータスコード:** `400 Bad Request`
* **エラーメッセージ (例):** 「無効なCanva URLです。スマート埋め込み用のURLを確認してください。」

## 6. TODO (要確認)
* [ ] 実際にCanvaから「スマート埋め込み」URLを複数パターン（プレゼン、ドキュメント等）取得し、上記 3.2 と 3.3 のパターン定義が正しいか最終確認する。