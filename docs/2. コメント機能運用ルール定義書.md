## 2.1. スレッド表現 (親子関係と階層)

* コメントへの返信（スレッド）は、`parentId` フィールドと `depth` フィールドを用いて表現します。
* **トップレベルのコメント (親コメント)**
    * `parentId` には `null` を設定します。
    * `depth` には `0` を設定します。
* **返信コメント (子コメント)**
    * `parentId` には、返信対象のコメントのドキュメントIDを設定します。
    * `depth` には、親の `depth + 1` を設定します。（例: 親が `depth: 0` なら、子は `depth: 1`）
* （UI/UX上の考慮事項）アプリのUI上、一定の深さ（例: `depth` が3以上）の返信はインデントを増やさない、または返信ボタンを非表示にすることを検討します。

## 2.2. ソフト削除と非表示運用

* ユーザー体験とデータ整合性を考慮し、コメントの削除はソフト削除方式を採用します。
* **ユーザーによる削除 (ソフト削除)**
    * ユーザーが自身のコメントを削除した場合、データベースからドキュメントを物理的に削除する（ハード削除）のではなく、`comments` ドキュメントの `isDeleted` フィールドを `true` に更新します。
    * クライアントアプリは、`isDeleted` が `true` のコメントを検知した場合、`authorId` や `text` の内容を表示せず、「このコメントは削除されました」という固定メッセージを表示します。
    * このコメントに返信（子コメント）が付いている場合でも、そのツリー構造は維持されます。これにより、「削除されたコメントへの返信」が表示される状況を自然に表現できます。
* **管理者による非表示 (将来的な拡張)**
    * もし将来的に、利用規約違反のコメントを管理者権限で非表示にする機能が必要になった場合は、`isHidden: boolean` のようなフィールドを `comments` スキーマに追加することを検討します。
    * `isHidden: true` のドキュメントは、セキュリティルールレベルで読み取りを拒否するか、クライアント側で完全に非表示（レンダリングしない）として扱います。これは `isDeleted`（削除された事実を”表示する”）とは異なる挙動です。

## フィールド: comments に必要なフィールド

* `content`: (String) コメント本文
* `createdAt`: (Timestamp) 作成日時
* `userId`: (String) 投稿者のID
* `postId`: (String) 紐づく投稿のID
* **（タスク4.2の要件）** `isDeleted`: (Boolean) ソフト削除用フラグ
* **（タスク4.2の要件）** `parentId`: (String) 返信先のコメントID (親コメントの場合は `null`)
* **（タスク4.2の要件）** `depth`: (Number) コメントの階層の深さ (親は0, 返信は1...)
* **（冗長化フィールド）** `userName`: (String) 投稿者の表示名
* **（冗長化フィールド）** `userIconUrl`: (String) 投稿者のアイコン画像URL
    * *（補足: `userName` と `userIconUrl` は、コメント表示時のアプリ側の読み取りコストとパフォーマンスを最適化するために、コメント投稿時に `users` コレクションからコピーして保存します（非正規化）。）*