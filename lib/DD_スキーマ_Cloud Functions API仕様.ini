````
# EMCA 掲示板 v1 詳細技術設計チェックリスト
## Notes
- 投稿本体: Notion。コメント/いいね/ブックマーク/通知/集計: Firebase（Firestore/FCM）。カバー画像: Firebase Storage。
- 外部リンクURL: Canvaスマート埋め込みのみ許可。WebViewで表示、ブロック時は警告＋外部ブラウザで開くボタン。
- 並び順: 公開日時の新しい順。未来日時も表示。ページ番号式（1ページ20件）。
- 検索/絞り込み: メタのみ（タイトル/サマリー/カテゴリ名/タグ名）。カテゴリは単一、タグはOR。全体はANDで適用。
- コメント: 無制限ネスト。古い順。親20件/ページ、返信は親ごとに都度読み込み。テキストのみ（1000文字、改行可）。
- いいね/ブックマーク: 投稿のみ対象。いいねはトグル。一覧はいいね数のみ表示（Firestore集計）。
- 通知: コメント（自分の投稿）/返信（自分のコメント）/いいね。全体オン/オフのみ（既定ON）。
- 時刻: 保存UTC、表示は端末ローカル。キャッシュTTL: 一覧60秒、詳細300秒。保存/削除時に該当＋一覧をパージ。

# Tasks
- [ ] 1.0 Notion 投稿DBスキーマ
  - [ ] 1.1 フィールド定義（型/必須/説明を記載）
    - [ ] 1.1.1 `Title`（Title, 必須, 最大60文字）
    - [ ] 1.1.2 `Summary`（Rich text, 任意, 最大160文字）
    - [ ] 1.1.3 `External Link URL`（URL, 必須, Canvaスマート埋め込みのみ）
    - [ ] 1.1.4 `Published At`（Date, 必須, サーバーUTC自動設定）
    - [ ] 1.1.5 `Category`（Select, 任意, 初期候補を登録）
    - [ ] 1.1.6 `Tags`（Relation→タグDB, 必須, 選択1〜5）
    - [ ] 1.1.7 `Author User ID`（Text, 必須）
    - [ ] 1.1.8 `Author Name`（Text, 必須, 表示はFirebaseプロフィール優先）
    - [ ] 1.1.9 `Cover Image URL`（URL or Files, 任意, PNG/JPG, ≤5MB, 16:9中央トリミング）
    - [ ] 1.1.10 `Language/Region`（Select or Text, 任意）
    - [ ] 1.1.11 `Body`（Rich text, 任意, v1表示では未使用）
    - [ ] 1.1.12 `Pin`（Checkbox/Number, 任意, v1では未使用）
  - [ ] 1.2 カテゴリ候補を登録（臨床実習/国家試験/初期研修・就職活動/入試・編入対策/学生生活・Q&A）
  - [ ] 1.3 ビュー定義（新着順ビュー、カテゴリ/タグ別ビュー）
  - [ ] 1.4 アクセス権限の運用整理（運営編集、一般は参照不可）

- [ ] 2.0 Notion タグDBスキーマ
  - [ ] 2.1 フィールド定義
    - [ ] 2.1.1 `Name`（Title, 必須）
    - [ ] 2.1.2 `Group`（Select, 必須：国・地域/試験関連/勉強法/生活関連/投稿の種類）
  - [ ] 2.2 初期タグを全登録（提示リストの全候補）
  - [ ] 2.3 投稿DBとのRelation設定（多対多/選択上限5の運用）

- [ ] 3.0 Firestore スキーマ
  - [ ] 3.1 `comments`（コレクション）
    - [ ] 3.1.1 フィールド: `postId`(Notion page ID), `commentId`(自動), `parentId`(nullable), `userId`, `body`, `createdAt`, `updatedAt`(任意), `deletedAt`(nullable), `hidden`(bool, 管理者非表示), `depth`(数値, 任意)
    - [ ] 3.1.2 インデックス: `postId+createdAt`昇順、`parentId+createdAt`昇順
  - [ ] 3.2 `likes`
    - [ ] 3.2.1 フィールド: `postId`, `userId`, `createdAt`
    - [ ] 3.2.2 一意性: `postId+userId`重複禁止（アプリ/関数で担保）
    - [ ] 3.2.3 インデックス: `postId`（任意）
  - [ ] 3.3 `bookmarks`
    - [ ] 3.3.1 フィールド: `postId`, `userId`, `createdAt`
    - [ ] 3.3.2 インデックス: `userId+createdAt`（将来の一覧用）
  - [ ] 3.4 `postStats`
    - [ ] 3.4.1 フィールド: `postId`, `likesCount`（必須）
    - [ ] 3.4.2 一貫性: いいねトグル時に増減
  - [ ] 3.5 `notifications`
    - [ ] 3.5.1 フィールド: `userId`, `type`(comment/reply/like), `postId`, `commentId`(nullable), `title`(短文), `createdAt`, `read`(bool)
    - [ ] 3.5.2 インデックス: `userId+createdAt`降順
  - [ ] 3.6 `userSettings`
    - [ ] 3.6.1 フィールド: `userId`, `notificationsEnabled`(bool, 既定true)

- [ ] 4.0 Firestore セキュリティ/運用
  - [ ] 4.1 認証必須のリード/ライト方針（一覧/詳細はFunctions経由、コメント/リアクションは認証必須）
  - [ ] 4.2 所有権チェック（コメント削除は本人または管理者のみ）
  - [ ] 4.3 管理者ロールの判定方針（Claims/名簿）

- [ ] 5.0 Storage（カバー画像）
  - [ ] 5.1 バケット運用（認証ユーザーのみアップロード可）
  - [ ] 5.2 受け入れ条件（PNG/JPG, ≤5MB, 16:9以外は中央トリミングの運用）
  - [ ] 5.3 公開URLの生成とNotion保存フロー（保存場所/命名規則）

- [ ] 6.0 Cloud Functions API（Notion連携）
  - [ ] 6.1 POST `/posts`（投稿作成）
    - [ ] 6.1.1 入力: `title`, `externalLinkUrl`(Canva埋め込み), `category`(任意), `tagIds`(1〜5), `coverImageUrl`(任意)
    - [ ] 6.1.2 検証: タイトル≤60, サマリー≤160（任意入力時）, タグ1〜5, Canva埋め込みURL形式
    - [ ] 6.1.3 処理: `publishedAt`をUTCで自動設定→Notion保存→キャッシュパージ（詳細＋一覧）
    - [ ] 6.1.4 応答: 投稿メタ（NotionページID含む）
  - [ ] 6.2 GET `/posts`（一覧）
    - [ ] 6.2.1 入力: `page`（1始まり）, `pageSize`=20固定, `q`（メタのみ）, `category`, `tagIds[]`（OR）
    - [ ] 6.2.2 並び: `published_at`降順。TTL=60秒。
    - [ ] 6.2.3 応答: `items[]`, `page`, `totalPages`（可能なら）
  - [ ] 6.3 GET `/posts/{postId}`（詳細）
    - [ ] 6.3.1 内容: 投稿メタ＋Canva埋め込みURL。TTL=300秒。
  - [ ] 6.4 POST `/likes/toggle`
    - [ ] 6.4.1 処理: `likes`の存在でトグル、`postStats.likesCount`を増減
  - [ ] 6.5 POST `/bookmarks/toggle`
    - [ ] 6.5.1 処理: 追加/削除のトグル
  - [ ] 6.6 POST `/comments`（作成）
    - [ ] 6.6.1 入力: `postId`, `parentId`(任意), `body`（≤1000, 改行可）
    - [ ] 6.6.2 並び: 古い順の前提で`createdAt`設定
  - [ ] 6.7 DELETE `/comments/{commentId}`（削除）
    - [ ] 6.7.1 処理: ソフト削除（本文は「[削除済み]」、子は残す）
  - [ ] 6.8 GET `/comments`（親一覧）
    - [ ] 6.8.1 入力: `postId`, `page`（1始まり）, `pageSize`=20固定
    - [ ] 6.8.2 並び: 古い順
  - [ ] 6.9 GET `/comments/{parentId}/replies`（返信）
    - [ ] 6.9.1 入力: `page`/`pageSize`（必要に応じ）
    - [ ] 6.9.2 並び: 古い順
  - [ ] 6.10 管理API（コメント）
    - [ ] 6.10.1 POST `/admin/comments/{id}/hide`（非表示トグル）
    - [ ] 6.10.2 POST `/admin/comments/{id}/soft-delete`（ソフト削除）
  - [ ] 6.11 GET `/me/posts`（自分の投稿一覧）
  - [ ] 6.12 GET `/notifications`（通知履歴）
  - [ ] 6.13 POST `/me/notification-settings`（通知全体オン/オフ）

- [ ] 7.0 検索/絞り込み仕様（実装ルール）
  - [ ] 7.1 キーワードはタイトル/サマリー/カテゴリ名/タグ名のみ対象
  - [ ] 7.2 カテゴリは単一一致
  - [ ] 7.3 タグはOR一致
  - [ ] 7.4 全体はANDで適用（q ∧ category ∧ tags(OR)）

- [ ] 8.0 キャッシュ/パージ設計
  - [ ] 8.1 キー設計（一覧: フィルタ/ページ組合せ、詳細: postId）
  - [ ] 8.2 TTL設定（一覧60秒、詳細300秒）
  - [ ] 8.3 パージ条件（投稿作成/削除時に詳細＋一覧）

- [ ] 9.0 通知設計
  - [ ] 9.1 トリガー: 新規コメント（投稿者へ）/返信（親コメントの投稿者へ）/いいね（投稿者へ）
  - [ ] 9.2 配信条件: `userSettings.notificationsEnabled == true`
  - [ ] 9.3 ペイロード設計: `type`, `postId`, `commentId`(任意), `title`要約, `createdAt`
  - [ ] 9.4 タップ遷移: 詳細WebView（コメントパネルは自動展開しない）

- [ ] 10.0 埋め込み/フォールバック
  - [ ] 10.1 Canvaスマート埋め込みURLの形式検証（ドメイン/パス/クエリの許可範囲）
  - [ ] 10.2 WebViewブロック検知時のUI（警告＋外部ブラウザボタン）

- [ ] 11.0 タイムゾーン/日付
  - [ ] 11.1 `published_at`はUTC保存
  - [ ] 11.2 API応答はISO8601/RFC3339またはエポックmsで返す方針を定義
  - [ ] 11.3 クライアント表示は端末ローカルタイム

- [ ] 12.0 エラーハンドリング/レスポンス
  - [ ] 12.1 検証エラー（400系）のエラー型/メッセージ規約を定義
  - [ ] 12.2 権限/認証エラー（401/403）、存在しない（404）、レート/制限（429/503相当）の扱い
  - [ ] 12.3 冪等性の扱い（いいね/ブックマークリトライ時の多重防止）

- [ ] 13.0 監視/運用
  - [ ] 13.1 ログ方針（構造化ログ、相関ID、ユーザーIDの匿名化）
  - [ ] 13.2 アラート条件（関数失敗率、Notion APIレート超過）
  - [ ] 13.3 バックオフ/リトライ方針（Notion APIの429/5xx対応）

- [ ] 14.0 受け入れテストデータ
  - [ ] 14.1 カテゴリ/タグの本番候補を投入
  - [ ] 14.2 テストユーザー（一般/管理者）を用意
  - [ ] 14.3 テスト投稿（カバー画像有/無、タグ境界、埋め込み可/不可）を準備
````