# APIキャッシュ戦略 (v1.0 Draft)

## 1. 目的
Cloud Functionsで提供するAPIの応答速度を向上させ、Notion APIへのアクセス負荷を軽減するため、キャッシュ戦略を定義します。

## 2. 基本方針
* キャッシュの保存先: [Redis (MemoryStore) / または Cloud Functions のインメモリキャッシュ ※未定]
* キャッシュの実装: ミドルウェアまたは専用のラッパー関数で行う。

## 3. キャッシュ対象とTTL（生存時間）
| APIエンドポイント | TTL (秒) | 説明 |
| :--- | :--- | :--- |
| `GET /posts` (一覧) | 60秒 | 新規投稿の反映ラグを許容しつつ、負荷軽減を優先する。 |
| `GET /posts/{id}` (詳細) | 300秒 | 記事内容は頻繁に更新されないため、長めに設定する。 |

---

## 4. キャッシュキー設計
キャッシュを一意に識別するためのキー設計を以下のように定めます。

### 4.1 詳細ページ (`GET /posts/{id}`)
* **形式:** `post_detail:[POST_ID]`
* **例:** `post_detail:a1b2c3d4-e5f6-7890-g1h2-i3j4k5l6m7n8`

### 4.2 一覧ページ (`GET /posts`)
一覧はリクエストクエリ（ページ、キーワード、カテゴリ、タグ）に応じて結果が変動するため、これらをすべてキーに含めます。

* **形式:** `posts_list:p[PAGE]:q[KEYWORD_HASH]:cat[CATEGORY_ID]:tags[TAG_IDS_HASH]`
* **各要素のルール:**
    * `PAGE`: 必須。ページ番号。（例: `p1`）
    * `KEYWORD_HASH`: `q=` パラメータ。空の場合は `q_` とする。検索語はハッシュ化（例: MD5の先頭8文字など）してキーの長さを抑える。（例: `q_a1b2c3d4`）
    * `CATEGORY_ID`: `category=` パラメータ。空の場合は `cat_` とする。（例: `cat_z9y8x7w6`）
    * `TAG_IDS_HASH`: `tags=` パラメータ（複数の場合はIDをソートして連結）。空の場合は `tags_` とする。連結したID群をハッシュ化する。（例: `tags_f5e6d7c8`）
* **例 (全指定時):** `posts_list:p1:q_a1b2c3d4:cat_z9y8x7w6:tags_f5e6d7c8`
* **例 (ページのみ):** `posts_list:p1:q_:cat_:tags_`

*(代替案: もしキーのハッシュ化実装が複雑な場合、当面は検索条件（q, cat, tags）が指定された場合はキャッシュせず、`p=` のみの新着一覧のみを `posts_list:p[PAGE]` としてキャッシュする、という簡易版も検討する)*

---

## 5. キャッシュパージ（削除）戦略
キャッシュの整合性を保つため、特定のイベント発生時にキャッシュを能動的に削除（パージ）します。

| アクション | 対象API | パージするキャッシュ | 備考 |
| :--- | :--- | :--- | :--- |
| **新規投稿** | `POST /posts` | `posts_list:*` | **すべての一覧キャッシュ** を削除する。<br>(キーのパターンマッチで一括削除) |
| **投稿更新** | `PUT /posts/{id}` (仮) | `post_detail:[ID]` <br> `posts_list:*` | 該当記事の詳細キャッシュと、**すべての一覧キャッシュ** を削除する。 |
| **投稿削除** | `DELETE /posts/{id}` (仮) | `post_detail:[ID]` <br> `posts_list:*` | 該当記事の詳細キャッシュと、**すべての一覧キャッシュ** を削除する。 |
| **いいね/ブクマ増減** | (Sprint 5) | `post_detail:[ID]` | 該当記事の詳細キャッシュのみ削除（またはカウントアップ更新）。<br> **一覧キャッシュはパージしない。** (60秒のTTL切れによる自然更新を待つ) |

## 6. リスク・未決事項
* [ ] キャッシュの保存先（インメモリ vs Redis/MemoryStore）の決定。インメモリ形式の方が無料のためベター。
* [ ] 一覧キャッシュのキー設計（ハッシュ方式）の実装コスト見積もり。
* [ ] `posts_list:*` でパターン削除が可能なキャッシュ基盤であることの確認。
```